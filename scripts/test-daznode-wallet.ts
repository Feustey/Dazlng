#!/usr/bin/env tsx

import { createUnifiedLightningService } from '../lib/services/unified-lightning-service';
import { createDazNodeWalletService } from '../lib/services/daznode-wallet-service';
import fetch from 'node-fetch';

// Configuration pour les tests
const TEST_CONFIG = {
  baseUrl: process.env.NEXTAUTH_URL || 'http://localhost:3000',
  testAmount: 1000, // 1000 sats
  testDescription: 'Test wallet DazNode - ' + new Date().toISOString()
};

async function testDazNodeWallet() {
  console.log('üß™ TEST WALLET DAZNODE v2.0\n');
  console.log('=======================================\n');

  let totalTests = 0;
  let passedTests = 0;
  let failedTests = 0;

  // Fonction utilitaire pour marquer les tests
  const markTest = (passed: boolean, testName: string, details?: string) => {
    totalTests++;
    if (passed) {
      passedTests++;
      console.log(`‚úÖ ${testName}`);
      if (details) console.log(`   ${details}`);
    } else {
      failedTests++;
      console.log(`‚ùå ${testName}`);
      if (details) console.log(`   ${details}`);
    }
    console.log('');
  };

  try {
    // Test 1: V√©rification des cl√©s DazNode
    console.log('1Ô∏è‚É£ Test des cl√©s publiques DazNode...');
    const expectedAppPubkey = '69620ced6b014d8b6013aa86c6b37cd86f28a5843ce8b430b5d96d7bc991c697';
    const expectedWalletPubkey = 'de79365f2b0b81561d7eb12963173a80a3e78ff0c88262dcdde0118a9deb8e30';
    
    const appPubkey = process.env.APP_PUKEY || process.env.DAZNODE_APP_PUBLIC_KEY || expectedAppPubkey;
    const walletPubkey = process.env.WALLET_PUKEY || process.env.DAZNODE_WALLET_PUBLIC_KEY || expectedWalletPubkey;
    
    markTest(appPubkey === expectedAppPubkey, 'App Public Key DazNode', 
      `${appPubkey.substring(0, 20)}...${appPubkey === expectedAppPubkey ? ' (configur√©)' : ' (diff√©rent)'}`);
    
    markTest(walletPubkey === expectedWalletPubkey, 'Wallet Public Key DazNode',
      `${walletPubkey.substring(0, 20)}...${walletPubkey === expectedWalletPubkey ? ' (configur√©)' : ' (diff√©rent)'}`);

    // Test 2: Initialisation du service DazNode direct
    console.log('2Ô∏è‚É£ Test service DazNode direct...');
    let dazNodeService;
    try {
      dazNodeService = createDazNodeWalletService();
      markTest(true, 'Service DazNode initialis√©', 'Connexion NWC configur√©e');
    } catch (error) {
      markTest(false, 'Service DazNode initialis√©', 
        `Erreur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
    }

    // Test 3: Informations wallet DazNode
    if (dazNodeService) {
      console.log('3Ô∏è‚É£ Test informations wallet DazNode...');
      try {
        const walletInfo = await dazNodeService.getWalletInfo();
        
        if (walletInfo.isOnline && walletInfo.walletInfo) {
          markTest(true, 'Wallet DazNode en ligne', 
            `Balance: ${walletInfo.walletInfo.balance} sats | Alias: ${walletInfo.walletInfo.alias}`);
        } else {
          markTest(false, 'Wallet DazNode en ligne', 'Wallet hors ligne ou inaccessible');
        }
      } catch (error) {
        markTest(false, 'Wallet DazNode en ligne', 
          `Erreur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
      }
    }

    // Test 4: Service unifi√© (doit utiliser DazNode par d√©faut)
    console.log('4Ô∏è‚É£ Test service Lightning unifi√©...');
    let unifiedService;
    try {
      unifiedService = createUnifiedLightningService();
      const provider = unifiedService.getProvider();
      
      markTest(provider === 'daznode', 'Service unifi√© utilise DazNode', 
        `Provider d√©tect√©: ${provider}`);
    } catch (error) {
      markTest(false, 'Service unifi√© utilise DazNode', 
        `Erreur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
    }

    // Test 5: G√©n√©ration de facture via service unifi√©
    if (unifiedService) {
      console.log('5Ô∏è‚É£ Test g√©n√©ration facture (service unifi√©)...');
      let testInvoice;
      try {
        testInvoice = await unifiedService.generateInvoice({
          amount: TEST_CONFIG.testAmount,
          description: TEST_CONFIG.testDescription,
          expiry: 3600
        });
        
        markTest(true, 'Facture g√©n√©r√©e via service unifi√©', 
          `ID: ${testInvoice.id?.substring(0, 20)}... | Montant: ${testInvoice.amount} sats`);
      } catch (error) {
        markTest(false, 'Facture g√©n√©r√©e via service unifi√©', 
          `Erreur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
      }

      // Test 6: V√©rification statut facture
      if (testInvoice) {
        console.log('6Ô∏è‚É£ Test v√©rification statut facture...');
        try {
          const status = await unifiedService.checkInvoiceStatus(testInvoice.paymentHash);
          
          markTest(status.status === 'pending', 'Statut facture v√©rifi√©', 
            `Statut: ${status.status} | Montant: ${status.amount || 'N/A'} sats`);
        } catch (error) {
          markTest(false, 'Statut facture v√©rifi√©', 
            `Erreur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
        }
      }
    }

    // Test 7: Test endpoint API create-invoice
    console.log('7Ô∏è‚É£ Test endpoint API /api/create-invoice...');
    try {
      const response = await fetch(`${TEST_CONFIG.baseUrl}/api/create-invoice`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: TEST_CONFIG.testAmount,
          description: TEST_CONFIG.testDescription + ' (API Test)'
        })
      });

      if (response.ok) {
        const data = await response.json() as any;
        const hasInvoice = data.success && data.data?.invoice?.payment_request;
        const isDazNodeProvider = data.meta?.provider === 'daznode';
        
        markTest(hasInvoice && isDazNodeProvider, 'Endpoint API utilise DazNode', 
          `Provider: ${data.meta?.provider} | Version: ${data.meta?.version}`);
        
        // Test 8: Test endpoint API check-invoice
        if (hasInvoice) {
          console.log('8Ô∏è‚É£ Test endpoint API /api/check-invoice...');
          const checkResponse = await fetch(
            `${TEST_CONFIG.baseUrl}/api/check-invoice?id=${data.data.invoice.payment_hash}`
          );
          
          if (checkResponse.ok) {
            const checkData = await checkResponse.json() as any;
            const hasStatus = checkData.success && checkData.data?.status;
            const isDazNodeCheck = checkData.meta?.provider === 'daznode';
            
            markTest(hasStatus && isDazNodeCheck, 'Endpoint check-invoice utilise DazNode', 
              `Statut: ${checkData.data?.status} | Provider: ${checkData.meta?.provider}`);
          } else {
            markTest(false, 'Endpoint check-invoice utilise DazNode', 
              `Erreur HTTP: ${checkResponse.status}`);
          }
        }
      } else {
        markTest(false, 'Endpoint API utilise DazNode', 
          `Erreur HTTP: ${response.status}`);
      }
    } catch (error) {
      markTest(false, 'Endpoint API utilise DazNode', 
        `Erreur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
    }

    // Test 9: Validation des factures BOLT11
    console.log('9Ô∏è‚É£ Test validation format BOLT11...');
    try {
      const testResponse = await fetch(`${TEST_CONFIG.baseUrl}/api/create-invoice`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: 100,
          description: 'Test BOLT11'
        })
      });

      if (testResponse.ok) {
        const data = await testResponse.json() as any;
        const bolt11 = data.data?.invoice?.payment_request;
        const isValidBolt11 = bolt11 && bolt11.toLowerCase().startsWith('ln');
        
        markTest(isValidBolt11, 'Format BOLT11 valide', 
          `Facture: ${bolt11?.substring(0, 30)}...`);
      } else {
        markTest(false, 'Format BOLT11 valide', 'Impossible de g√©n√©rer facture test');
      }
    } catch (error) {
      markTest(false, 'Format BOLT11 valide', 
        `Erreur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
    }

    // Fermeture des connexions
    if (dazNodeService) {
      await dazNodeService.close();
    }
    if (unifiedService) {
      await unifiedService.close();
    }

    // R√©sum√© final
    console.log('\nüìä R√âSUM√â TEST WALLET DAZNODE');
    console.log('==============================');
    console.log(`Total des tests: ${totalTests}`);
    console.log(`‚úÖ Tests r√©ussis: ${passedTests}`);
    console.log(`‚ùå Tests √©chou√©s: ${failedTests}`);
    console.log(`üìà Taux de r√©ussite: ${Math.round((passedTests / totalTests) * 100)}%\n`);

    if (failedTests === 0) {
      console.log('üéâ WALLET DAZNODE PARFAITEMENT CONFIGUR√â !');
      console.log('\nüí° Le syst√®me utilise maintenant le wallet DazNode pour :');
      console.log('   ‚úÖ G√©n√©ration de factures Lightning');
      console.log('   ‚úÖ V√©rification des paiements');
      console.log('   ‚úÖ R√©ception des paiements sur le wallet DazNode');
      console.log('\nüîë Cl√©s configur√©es :');
      console.log(`   App Public Key: ${expectedAppPubkey.substring(0, 20)}...`);
      console.log(`   Wallet Public Key: ${expectedWalletPubkey.substring(0, 20)}...`);
      
      process.exit(0);
    } else {
      console.log('‚ö†Ô∏è CONFIGURATION PARTIELLEMENT R√âUSSIE');
      console.log('\nüîß Actions correctives possibles :');
      
      if (failedTests > 3) {
        console.log('   1. V√©rifier la connectivit√© internet');
        console.log('   2. V√©rifier que le relay Alby est accessible');
        console.log('   3. Valider les cl√©s publiques DazNode');
      }
      
      console.log('   4. Consulter les logs pour plus de d√©tails');
      console.log('   5. Tenter une r√©initialisation du wallet NWC');
      
      process.exit(1);
    }

  } catch (error) {
    console.error('\nüí• ERREUR CRITIQUE LORS DU TEST:', error);
    console.log('\nüÜò Le wallet DazNode n\'est pas accessible');
    process.exit(1);
  }
}

// Ex√©cution du script
if (require.main === module) {
  testDazNodeWallet().catch(console.error);
}

export { testDazNodeWallet }; 