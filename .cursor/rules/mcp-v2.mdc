---
description: 
globs: 
alwaysApply: true
---
# MCP V2 - Architecture & Standards de DÃ©veloppement

## ğŸ“š Documentation de RÃ©fÃ©rence

Les spÃ©cifications complÃ¨tes et rÃ¨gles de dÃ©veloppement sont disponibles dans :
- [V2.md](mdc:_Roadmap/V2.md) - SpÃ©cifications fonctionnelles et techniques
- [MCP_V2_RULES.md](mdc:_Roadmap/MCP_V2_RULES.md) - Standards et bonnes pratiques

## ğŸ— Architecture GÃ©nÃ©rale

### Services Core
Tous les services doivent Ãªtre implÃ©mentÃ©s dans `lib/services/` avec la structure suivante :

```typescript
// âœ… CORRECT - Service avec injection de dÃ©pendances
class Service implements IService {
  constructor(
    private dependency1: IDependency1,
    private dependency2: IDependency2
  ) {}
}

// âŒ INCORRECT - Couplage fort
class Service {
  private dependency = new Dependency();
}
```

### Validation des DonnÃ©es
Utiliser Zod pour toute validation dans `lib/validations/` :

```typescript
// âœ… CORRECT - SchÃ©ma Zod
const schema = z.object({
  field: z.string().min(1),
  amount: z.number().min(1000)
});

// âŒ INCORRECT - Validation manuelle
if (!data.field || data.amount < 1000) {
  throw new Error('Invalid data');
}
```

## ğŸš€ Modules Principaux

### 1. MCP Yield Finance
- Service principal : [lib/services/mcp-yield-service.ts](mdc:lib/services/mcp-yield-service.ts)
- Validation : [lib/validations/yield.ts](mdc:lib/validations/yield.ts)
- API Routes : [app/api/v1/yield/*](mdc:app/api/v1/yield)

### 2. MCP Liquidity Subscriptions
- Service principal : [lib/services/mcp-liquidity-service.ts](mdc:lib/services/mcp-liquidity-service.ts)
- Validation : [lib/validations/liquidity.ts](mdc:lib/validations/liquidity.ts)
- API Routes : [app/api/v1/liquidity/*](mdc:app/api/v1/liquidity)

### 3. MCP Marketplace & IA
- Service principal : [lib/services/mcp-marketplace-service.ts](mdc:lib/services/mcp-marketplace-service.ts)
- IA Service : [lib/services/marketplace-ai.ts](mdc:lib/services/marketplace-ai.ts)
- API Routes : [app/api/v1/marketplace/*](mdc:app/api/v1/marketplace)

### 4. MCP LINER Index
- Service principal : [lib/services/mcp-liner-service.ts](mdc:lib/services/mcp-liner-service.ts)
- Cache : [lib/services/liner-cache.ts](mdc:lib/services/liner-cache.ts)
- API Routes : [app/api/v1/index/liner/*](mdc:app/api/v1/index/liner)

## ğŸ“Š Base de DonnÃ©es

### SchÃ©mas
Toutes les migrations doivent Ãªtre dans `supabase/migrations/` avec la nomenclature :
```sql
-- âœ… CORRECT
YYYYMMDD_feature_name.sql

-- âŒ INCORRECT
migration_1.sql
```

### Indexes
CrÃ©er des index optimisÃ©s avec conditions :
```sql
-- âœ… CORRECT
CREATE INDEX idx_name ON table (column1, column2)
WHERE condition = true;

-- âŒ INCORRECT
CREATE INDEX idx_name ON table (column);
```

## ğŸ”’ SÃ©curitÃ© & Monitoring

### JWT & Auth
Utiliser les utilitaires dans [lib/auth/jwt.ts](mdc:lib/auth/jwt.ts) :
```typescript
// âœ… CORRECT
const token = await generateSecureToken(payload);

// âŒ INCORRECT
const token = jwt.sign(payload, process.env.SECRET);
```

### Logging
Utiliser le logger structurÃ© dans [lib/utils/logger.ts](mdc:lib/utils/logger.ts) :
```typescript
// âœ… CORRECT
logger.info('Action performed', { 
  action: 'yield_calculation',
  duration: 123,
  user: userId
});

// âŒ INCORRECT
console.log('Action performed');
```

## ğŸ¯ Standards de Code

### TypeScript
- `strict: true` dans tsconfig.json
- Interfaces pour tous les modÃ¨les
- Pas de `any`, utiliser `unknown`

### API Routes
Format de rÃ©ponse standardisÃ© :
```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: unknown;
  };
  meta: {
    timestamp: string;
    version: string;
  };
}
```

### Tests
- Tests unitaires dans `__tests__/unit/`
- Tests d'intÃ©gration dans `__tests__/integration/`
- Tests e2e dans `__tests__/e2e/`

## ğŸ“ˆ MÃ©triques & Alerting

### MÃ©triques Business
ImplÃ©menter dans [lib/monitoring/metrics.ts](mdc:lib/monitoring/metrics.ts) :
```typescript
// âœ… CORRECT
metrics.businessMetric('yield_generated', amount, {
  strategy: strategyType,
  user: userId
});

// âŒ INCORRECT
metrics.counter('yield').inc(amount);
```

### Alerting
Configurer dans [lib/monitoring/alerts.ts](mdc:lib/monitoring/alerts.ts) :
```typescript
// âœ… CORRECT
alerts.configure({
  threshold: 0.01,
  channel: 'slack',
  escalation: ['level1', 'level2']
});

// âŒ INCORRECT
if (errorRate > 0.01) sendAlert();
```
